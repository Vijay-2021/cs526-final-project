## Project Structure

### ARM Specification Parsing Module

This module is under `/codegen-generator/targets/arm`
5066 LOC here.

Notable files:

- asl/arm_instrs.sexpr: Parser input
- asl/ARMAST.py: AST structure for parser
- asl/ARMParser.py: Parser for sexpr
- ARMEncodingFields.py: Opcode and filed value for a certain encoding.
- ARMIntrinsicClassify.py: Match a intrinsic to a corresponding encoding, opcode, and decoder.
- ARMSemanticGen.py: Decode the opcode and get corresponding parameter of pseudocode.
- AllSema.pickle: Gathered semantic before compiling, generated by `python3 -m ARMSemanticGen`
- ARMRoseLang.py: Either generates tests in Rosette, or serve as codegen for later phase.
- ARMManualCorrectAST.py: Some AST are manually revised, like vabd.
- intr.json: Intrinsic information collected from website.
- encodingmap.json: A mystery file that can convert instruction name to encoding.
- rosette_test/compiled.rkt: Compiled semantics
- rosette_test/ARMTest.cpp: Fuzz testcases generator, only runable on ARM machine
- rosette_test/alltests.rkt: Fuzz test for compiled semantics
- RosetteARMTest.py: Testgen generator, the output should replace the content of main function of ARMTest.cpp
- RoseARMCIntrinsicsWrappersEmitter.py: generate arm_wrappers.c, used for legalizer.

We also remember modifying rosette operations, where we add `bvarmshl` because it has different semantics from `bvshl`.
However, it doesn't come into use.

### Component modified in Similarity checker

We modified some components in similarity checker or transformation to pass some assertion failure.
I hope all modification are labeled by `Hotfix` somewhere.

### ARM Code legalizer

This module is under `/codegen-generator/tools/low-level-codegen/InstSelectors/arm`
232 LOC here
Notable files:

- ARMSemantics.py: Summary of Similarity checker
- arm.wrappers.c.ll: LLVM IR for intrinsics to be inlined
- RoseARMLegalizerGen.py: Legalizer generator
- ARMLegalizer.cpp: Legalizer to be compiled to shared library.

### Hydride Backend

This module is under `/code-synthesizer/dsl-ir` and `code-synthesizer/hydride/ir/arm`
253 LOC here

Notable files:
- dsl-ir/ARMSemantics.py: Summary of Similarity checker
- dsl-ir/EmitHydridePkgDefs.py: We modified this file to automatically generate ISA backend, this is used by `(cd /code-synthesizer/hydride/ir/arm && python3 -m EmitHydridePkgDefs)`
- hydride/ir/arm/*.rkt: ARM module files needed by Hydride, generated by EmitHydridePkgDefs.


### Halide Backend

This module is under `/frontends/halide/src/`

~300 LOC here

The only files we need to modify are `Rosette.cpp` and `CodeGen_LLVM.cpp`

## Build

0. `source setup.sh`
1. Racket
    ```
    wget https://download.racket-lang.org/installers/8.6/racket-8.6-x86_64-linux-cs.sh
    sh racket-8.6-x86_64-linux-cs.sh
    ```
2. Rosette and Hydride:
    ```
    raco pkg install rosette/
    raco pkg install code-synthesizer/hydride/
    ```
3. LLVM:
    Follow the instruction in `frontends/halide/install.sh`, this will hopefully build Halide together
4. Halide:
    make -C frontends/halide
5. Legalizer:
    ```
    cd codegen-generator/tools/low-level-codegen
    mkdir build && cd build
    cmake ..
    make
    ```
So far all component needed are built

## Run benchmarks

Simply `make arme.{benchmarkname}` at root folder, like `make arme.median3x3` by default or `make arme1.median3x3` using 1 expression depth (`EXPR_DEPTH=1`). This will compile the benchmark and run.
## Benchmark Status

- ARM A64
    - succeed
        - gaussian5x5
        - gaussian3x3
        - max_pool
        - median3x3
        - dilate5x5
        - dilate3x3
        - matmul_256_32bit
        - blur3x3
        - sobel3x3
    - failed:
        - average_pool: shr
        - mul: shr
        - l2norm: shr
        - add: shr


