#lang rosette

(require rosette/lib/synthax)
(require rosette/lib/angelic)
(require racket/pretty)


(define (_mm512_mask_reduce_add_epi32  k a )
(apply
concat
(for/list ([%outer.it (reverse (range 0 32 32))])
 (define dst(bv #b0 32))
 (define %5.sum
(apply
 bvadd
 (for/list ([j0.new (reverse (range 0 512 32))])
  (define j0.new.div (/  j0.new  32))
  (define %1 (extract  j0.new.div j0.new.div k))
  (if (equal? %1 (bv #b1 1))
   (begin
   (define %4 (+  j0.new  31))
   (define %5 (extract  %4 j0.new a))
   %5
   )
   (begin
   (bv #b0 32)
   )
  )
 )
))
 (define %3 (extract  31 0 dst))
 (define %6 (bvadd %5.sum %3))
 %6
)
)
)


;; Test the semantics
(define k16 (bv #xffff 16))

(define a64 (bv #x0002000200020002 64))
(define b64 (bv #x0002000300040005 64))
(define src64 (bv 0 64))

(define a128 (bv #x00010001000100010001000100010001 128))
(define b128 (bv #x00020003000200030002000300020003 128))
(define src128 (bv 0 128))
(define mask8 (bv #x0f 8))

(define a256 (bv #x0001000100010001000100010001000100010001000100010001000100010001 256))
(define b256 (bv #x0002000300020003000200030002000300020003000200030002000300020003 256))
(define src256 (bv 0 256))
(define mask16 (bv #x0f0f 16))

(define a512 (bv #x00010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001 512))
(define b512 (bv #x00020003000200030002000300020003000200030002000300020003000200030002000300020003000200030002000300020003000200030002000300020003 512))
(define src512 (bv 0 512))
(define mask128 (bv #x00010100000101000001010000010100 128))

(define a1024 (bv #x0001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001 1024))
(define b1024 (bv #x0001000100020003000200030002000300020003000200030002000300020003000200030002000300020003000200030002000300020003000200030002000300020003000200030002000300020003000200030002000300020003000200030002000300020003000200030002000300020003000200030002000300020003 1024))
(define src1024 (bv 0 1024))

(define (res)
  (pretty-print (_mm512_mask_reduce_add_epi32 k16 a512))
 )

(res)
